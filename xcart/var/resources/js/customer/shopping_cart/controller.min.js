function CartView(base){this.bind('local.postprocess',_.bind(this.assignHandlers,this));this.callSupermethod('constructor',arguments);core.bind('updateCart',_.bind(this.handleUpdateCart,this));core.bind('reassignEstimator',_.bind(this.assignEstimatorHandler,this));this.validate()};extend(CartView,ALoadable);CartView.autoload=function(){jQuery('#cart').each(function(){new CartView(this)})};CartView.prototype.shadeWidget=true;CartView.prototype.updatePageTitle=true;CartView.prototype.updateBreadcrumb=true;CartView.prototype.widgetTarget='cart';CartView.prototype.widgetClass='\\XLite\\View\\Cart';CartView.prototype.checkoutButton=jQuery('#cart ul.totals li.button button');CartView.prototype.selfUpdated=false;CartView.prototype.cartUpdated=false;CartView.prototype.assignHandlers=function(event,state){if(state.isSuccess){jQuery('td.item-subtotal div.including-modifiers',this.base).each(function(){attachTooltip(jQuery(this).parents('td.item-subtotal').find('.subtotal'),jQuery(this).html())});this.base.find('.selected-product form .remove').parents('form').commonController('enableBackgroundSubmit',_.bind(this.preprocessAction,this),_.bind(this.postprocessAction,this));jQuery('.selected-product form.update-quantity',this.base).commonController('enableBackgroundSubmit',_.bind(this.preprocessAction,this),_.bind(this.postprocessAction,this)).commonController('submitOnlyChanged',true);jQuery('form .clear-bag',this.base).parents('form').eq(0).commonController('enableBackgroundSubmit',_.bind(this.preprocessAction,this),_.bind(this.postprocessAction,this));this.assignEstimatorHandler()}};CartView.prototype.assignEstimatorHandler=function(){jQuery('button.estimate',this.base).parents('form').eq(0).submit(_.bind(function(event){return this.openShippingEstimator(event,event.currentTarget)},this));jQuery('a.estimate',this.base).click(_.bind(function(event){return this.openShippingEstimator(event,event.currentTarget)},this))};CartView.prototype.forceUpdateCartOnClose=false;CartView.prototype.openShippingEstimator=function(event,elm){if(!this.selfUpdated){this.selfUpdated=true;core.bind('afterPopupPlace',function(){StatesList.getInstance().updateStatesList();this.forceUpdateCartOnClose=true;jQuery('form.estimator, .estimate-methods form.method-change').submit(function(){var valid=this.commonController.validate({silent:true});if(valid)createOverlay($(this));core.bind('popup.close',_.once(function(){core.trigger('updateCart',{items:[]})}))})});jQuery('.ctrl-customer-shippingestimate').closest('.ui-dialog').remove();popup.load(elm,_.bind(function(event){this.closePopupHandler()},this))};return false};CartView.prototype.closePopupHandler=function(){if(this.cartUpdated)this.load();this.selfUpdated=false;this.cartUpdated=false};CartView.prototype.preprocessAction=function(){var result=false;if(!this.selfUpdated){this.selfUpdated=true;this.shade();jQuery('form.validationEngine',this.base).validationEngine('hide');result=true};return result};CartView.prototype.validate=function(){if(!jQuery('form.validationEngine',this.base).validationEngine('validate'))this.checkoutButton.prop('disabled','disabled').addClass('disabled add2cart-disabled')};CartView.prototype.postprocessAction=function(event,data){this.selfUpdated=false;this.cartUpdated=false;if(data.isValid){this.load()}else this.unshade()};CartView.prototype.handleUpdateCart=function(event,data){if(this.selfUpdated){this.cartUpdated=true}else this.load()};CartView.prototype.getEventNamespace=function(){return'cart.main'};core.autoload(CartView)