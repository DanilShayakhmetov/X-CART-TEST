CommonForm.elementControllers.push({pattern:'.inline-field',handler:function(){var field=jQuery(this),obj=this;this.viewValuePattern='.view';this.isAffectWholeLine=true;var line=field.parents('.line').eq(0),list=line.parents('.items-list').eq(0),row=line.get(0),inputs=jQuery('.field :input',this),vTab=!!list.data('vtab');this.getPositionIntoLine=function(){var inlineField=this,inlineFieldIndex=0;line.find('.inline-field').each(function(index){if(this==inlineField)inlineFieldIndex=index});return inlineFieldIndex};this.startEdit=function(){if(field.hasClass('editable')&&(!field.parents('.line').length||!field.parents('.line').hasClass('remove-mark'))){field.trigger('beforeStartEditInline');if(row&&this.isAffectWholeLine){line.addClass('edit-open-mark')}else field.addClass('edit-open-mark');jQuery('.field :input',this).first().focus();field.trigger('startEditInline')}};jQuery('.view',this).click(_.bind(this.startEdit,this));this.getViewValueElements=function(){return field.find(this.viewValuePattern)};this.saveField=function(){var value=this.getFieldFormattedValue();if(value!==undefined&&""!==value){var preparedValue=field.data('is-escape')&&(_.isUndefined(inputs.data().isEscape)||inputs.data('is-escape'))?htmlspecialchars(""==value?" ":value,null,null,false):(""==value?" ":value),data={value:preparedValue};field.trigger('beforeSaveFieldInline',data);this.getViewValueElements().html(data.value);field.trigger('afterSaveFieldInline',data)}else field.trigger('saveEmptyFieldInline')};this.endEdit=function(noSave){if(field.hasClass('edit-open-mark')){if(!noSave)this.saveField();field.removeClass('edit-open-mark');field.trigger('endEditInline')}};this.getFieldFormattedValue=function(input){input=input?jQuery(input).eq(0):inputs.eq(0);var result='';if(input)if(input.is('select')){if(input.is('[multiple]'))return result;var elm=input.get(0),option=jQuery(elm.options[elm.selectedIndex]);if(option.length)if(option.data('value')){result=option.data('value')}else result=elm.options[elm.selectedIndex].text}else result=input.val();return result};this.sanitize=function(){};this.isProcessBlur=function(){return true};inputs.bind('undo',function(){field.get(0).saveField()});inputs.blur(function(){var result=true;if(obj.isProcessBlur()){obj.sanitize();result=!jQuery(this).validationEngine('validate');if(result&&row)row.inlineGroupBlurTimeout=setTimeout(function(){row.inlineGroupBlurTimeout=false;row.saveFields()},100);obj.endEdit()};return result});inputs.focus(function(){if(row&&row.inlineGroupBlurTimeout){clearTimeout(row.inlineGroupBlurTimeout);row.inlineGroupBlurTimeout=false}});inputs.each(function(){var current=this;this.getNextInputs=function(){var found=false;return field.find('.field :input').find(function(){if(this==current)found=true;return found&&this!=current})};this.getPreviousInputs=function(){var found=true;return field.find('.field :input').find(function(){if(this==current)found=false;return found})}});inputs.keydown(function(event){var result={state:true};if(!vTab&&(9===event.keyCode||13===event.keyCode)&&!$(this).is('textarea')){if(!$(this).is('textarea')){$(this).trigger('enterPress',[event,result])}else if(event.metaKey||event.ctrlKey)$(this).trigger('enterPress',[event,result])}else if(27===event.keyCode)$(this).trigger('escPress',[event,result]);return result.state});inputs.bind('enterPress',function(currentEvent,event,result){var target=event.shiftKey?this.getPreviousInputs():this.getNextInputs();if(0<target.length){target.eq(0).focus()}else{var l=line,f,cell=jQuery(this).parents('.cell').filter(function(){return $(this).parent().hasClass('line')}).eq(0),index=cell.index();do{l=event.shiftKey?l.prev('.line'):l.next('.line');if(l.length)var f=l.find('> .cell').eq(index).find('.inline-field.editable .view')}while(l.length&&0==f.length);if(l.length&&f.length){result.state=false;f.click()}else jQuery(this).trigger('blur')}});inputs.bind('escPress',function(currentEvent,event,result){inputs.each(function(){var input=$(this);if(input.get(0).commonController&&!line.hasClass('create-line')){input.val(input.get(0).commonController.element.initialValue);input.change()}});jQuery(this).trigger('blur');result.state=false});if(row&&typeof(row.saveFields)=='undefined'){row.inlineGroupBlurTimeout=false;row.saveFields=function(){jQuery('.inline-field',this).each(function(){this.saveField();jQuery(this).removeClass('edit-mark')});jQuery(this).removeClass('edit-open-mark')};line.hover(function(){jQuery(this).addClass('edit-mark')},function(){jQuery(this).removeClass('edit-mark')})}}})